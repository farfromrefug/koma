name: Release
on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type for new release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    tags:
      - v*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Needed to push commits, tags, and create releases
  actions: read

jobs:
  prepare_version:
    if: github.repository == 'farfromrefug/koma'
    name: Prepare version
    runs-on: 'ubuntu-24.04'
    permissions:
      contents: write  # Needed to push version changes and tags
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      is_manual: ${{ steps.version.outputs.is_manual }}
      commit_sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          set -e

          # Check if triggered by tag push
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag-based release
            TAG="${GITHUB_REF/refs\/tags\//}"
            VERSION_NAME="${TAG#v}"
            echo "is_manual=false" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

            # Extract current versionCode from build.gradle.kts
            CURRENT_VERSION_CODE=$(grep -oP 'versionCode = \K\d+' app/build.gradle.kts)
            NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
            echo "version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT

            echo "Tag-based release: $TAG (versionName: $VERSION_NAME, versionCode: $NEW_VERSION_CODE)"
          else
            # Manual workflow_dispatch release
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            echo "is_manual=true" >> $GITHUB_OUTPUT

            # Get current version from build.gradle.kts
            CURRENT_VERSION=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts)
            CURRENT_VERSION_CODE=$(grep -oP 'versionCode = \K\d+' app/build.gradle.kts)

            echo "Current version: $CURRENT_VERSION (code: $CURRENT_VERSION_CODE)"

            # Validate version format (must be X.Y.Z)
            if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Current version '$CURRENT_VERSION' is not in the expected X.Y.Z format"
              exit 1
            fi

            # Parse current version
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"

            # Bump version based on bump_type
            case "$BUMP_TYPE" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
            NEW_TAG="v$NEW_VERSION"

            echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
            echo "version_name=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT

            echo "New version: $NEW_VERSION (code: $NEW_VERSION_CODE, tag: $NEW_TAG)"
          fi

      - name: Update version in build.gradle.kts
        run: |
          set -e

          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"

          echo "Updating version to: versionName=$VERSION_NAME, versionCode=$VERSION_CODE"

          # Update versionCode (extended regex - [0-9]+ matches one or more digits)
          sed -i -E "s/versionCode = [0-9]+/versionCode = $VERSION_CODE/" app/build.gradle.kts

          # Update versionName (extended regex - [^"]+ matches one or more non-quote characters)
          sed -i -E "s/versionName = \"[^\"]+\"/versionName = \"$VERSION_NAME\"/" app/build.gradle.kts

          # Verify the updates were successful
          UPDATED_VERSION_CODE=$(grep -oP 'versionCode = \K\d+' app/build.gradle.kts)
          UPDATED_VERSION_NAME=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts)

          if [[ "$UPDATED_VERSION_CODE" != "$VERSION_CODE" ]]; then
            echo "Error: Failed to update versionCode. Expected $VERSION_CODE, got $UPDATED_VERSION_CODE"
            exit 1
          fi

          if [[ "$UPDATED_VERSION_NAME" != "$VERSION_NAME" ]]; then
            echo "Error: Failed to update versionName. Expected $VERSION_NAME, got $UPDATED_VERSION_NAME"
            exit 1
          fi

          # Show the changes
          echo "Updated build.gradle.kts:"
          grep -A 2 "versionCode = " app/build.gradle.kts | head -3

      - name: Commit version changes
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet app/build.gradle.kts; then
            echo "No changes to commit"
          else
            git add app/build.gradle.kts
            git commit -m "chore: bump version to ${{ steps.version.outputs.version_name }} (code: ${{ steps.version.outputs.version_code }})"

            # Push changes
            if [[ "${{ steps.version.outputs.is_manual }}" == "true" ]]; then
              # For manual releases, push to the current branch
              git push origin HEAD:${{ github.ref_name }}

              # Create and push the tag
              git tag "${{ steps.version.outputs.tag }}"
              git push origin "${{ steps.version.outputs.tag }}"

              echo "Pushed version changes and created tag ${{ steps.version.outputs.tag }}"
            else
              # For tag-based releases, push the version update to the default branch
              # Note: The tag already exists, but we commit the version update to the branch

              # Get the default branch from GitHub API or use main as fallback
              DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
              if [[ -z "$DEFAULT_BRANCH" ]]; then
                DEFAULT_BRANCH="main"
              fi

              echo "Pushing version update to default branch: $DEFAULT_BRANCH"

              # Push to the default branch
              git push origin HEAD:refs/heads/$DEFAULT_BRANCH

              echo "Pushed version changes to branch $DEFAULT_BRANCH"
            fi
          fi

      - name: Save commit SHA
        id: commit
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  get_tag:
    if: github.repository == 'farfromrefug/koma'
    name: Extract tag name
    runs-on: 'ubuntu-24.04'
    needs: prepare_version
    outputs:
      tag: ${{ needs.prepare_version.outputs.tag }}

    steps:
      - name: Use prepared tag
        run: echo "Using tag ${{ needs.prepare_version.outputs.tag }}"

  build:
    if: github.repository == 'farfromrefug/koma'
    name: Build
    runs-on: 'ubuntu-24.04'
    needs: [prepare_version, get_tag]

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ needs.prepare_version.outputs.commit_sha }}

      - name: Set up JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 17
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0

      - name: Build
        run: ./gradlew assembleRelease -Penable-updater

      - name: Sign APK
        uses: r0adkll/sign-android-release@f30bdd30588842ac76044ecdbd4b6d0e3e813478
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: '35.0.1'

      - name: Rename APK
        run: |
          set -e

          mv app/build/outputs/apk/release/app-universal-release-unsigned-signed.apk koma-${{ needs.get_tag.outputs.tag }}.apk
          mv app/build/outputs/apk/release/app-arm64-v8a-release-unsigned-signed.apk koma-arm64-v8a-${{ needs.get_tag.outputs.tag }}.apk
          mv app/build/outputs/apk/release/app-armeabi-v7a-release-unsigned-signed.apk koma-armeabi-v7a-${{ needs.get_tag.outputs.tag }}.apk
          mv app/build/outputs/apk/release/app-x86-release-unsigned-signed.apk koma-x86-${{ needs.get_tag.outputs.tag }}.apk
          mv app/build/outputs/apk/release/app-x86_64-release-unsigned-signed.apk koma-x86_64-${{ needs.get_tag.outputs.tag }}.apk

      - name: Upload APK
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: koma
          path: |
            koma-${{ needs.get_tag.outputs.tag }}.apk
            koma-arm64-v8a-${{ needs.get_tag.outputs.tag }}.apk
            koma-armeabi-v7a-${{ needs.get_tag.outputs.tag }}.apk
            koma-x86-${{ needs.get_tag.outputs.tag }}.apk
            koma-x86_64-${{ needs.get_tag.outputs.tag }}.apk

  build_foss:
    if: github.repository == 'farfromrefug/koma'
    name: Build (FOSS)
    runs-on: ubuntu-24.04
    needs: [prepare_version, get_tag]

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ needs.prepare_version.outputs.commit_sha }}

      - name: Set up JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 17
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          cache-disabled: true

      - name: Build
        run: |
          ./gradlew assembleFoss -Penable-updater
          ls -la app/build/outputs/apk/foss

      - name: Sign APK
        uses: r0adkll/sign-android-release@f30bdd30588842ac76044ecdbd4b6d0e3e813478
        with:
          releaseDirectory: app/build/outputs/apk/foss
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: '35.0.1'

      - name: Rename APK
        run: |
          set -e
          ls -la app/build/outputs/apk/foss
          mv app/build/outputs/apk/foss/app-universal-foss-unsigned-signed.apk koma-${{ needs.get_tag.outputs.tag }}-foss.apk

      - name: Upload APK
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: koma-foss
          path: koma-${{ needs.get_tag.outputs.tag }}-foss.apk

  release:
    if: github.repository == 'farfromrefug/koma'
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [prepare_version, get_tag, build, build_foss]
    permissions:
      contents: write  # Needed to create releases
      actions: write  # Needed to delete artifacts

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ needs.prepare_version.outputs.commit_sha }}
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@14bb67385aaac969efa2f146d137a42bb3b0aa87 # v4.5.0
        with:
          config: .github/cliff.toml
          args: --verbose --latest --strip header
        env:
          OUTPUT: CHANGELOG.txt

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          merge-multiple: true

      - name: Delete all artifacts
        uses: geekyeggo/delete-artifact@f275313e70c08f6120db482d7a6b98377786765b # v5.1.0
        with:
          failOnError: false
          name: |
            koma
            koma-foss

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.get_tag.outputs.tag }}
          name: Koma ${{ needs.get_tag.outputs.tag }}
          body: |
            Check out the [past release notes](https://github.com/farfromrefug/koma/releases) if youâ€™re upgrading from an earlier version.

            <!-->

            ${{ steps.changelog.outputs.content }}

            <!-->

            > [!TIP]
            >
            > ### If you are unsure which version to download then go with `koma-${{ needs.get_tag.outputs.tag }}.apk`
          files: |
            koma-${{ needs.get_tag.outputs.tag }}.apk
            koma-${{ needs.get_tag.outputs.tag }}-foss.apk
            koma-arm64-v8a-${{ needs.get_tag.outputs.tag }}.apk
            koma-armeabi-v7a-${{ needs.get_tag.outputs.tag }}.apk
            koma-x86-${{ needs.get_tag.outputs.tag }}.apk
            koma-x86_64-${{ needs.get_tag.outputs.tag }}.apk
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          make_latest: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
